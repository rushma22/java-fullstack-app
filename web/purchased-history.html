<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>TechTopia - Products</title>
        <link rel="stylesheet" href="assets/css/notification.css">
        <style>
            :root{
                --tt-bg:#0f172a;
                --tt-card:#111827;
                --tt-text:#e5e7eb;
                --tt-muted:#94a3b8;
                --tt-accent:#22d3ee;
                --tt-ring:rgba(34,211,238,.35);
                --tt-green:#a7f3d0;
                --tt-danger:#ef4444;
            }
            body{
                margin:0;
                font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
                background:#0b1220;
                color:var(--tt-text)
            }
            header.tt-header{
                position:sticky;
                top:0;
                z-index:40;
                background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.90));
                border-bottom:1px solid rgba(255,255,255,.06);
                backdrop-filter:blur(8px) saturate(140%)
            }
            .tt-wrap{
                max-width:1200px;
                margin:0 auto;
                padding:14px 18px;
                display:flex;
                align-items:center;
                justify-content:space-between
            }
            .tt-logo{
                color:var(--tt-text);
                font-weight:800;
                font-size:20px;
                text-decoration:none;
                letter-spacing:.3px
            }
            .tt-logo::after{
                content:"";
                display:inline-block;
                margin-left:.5rem;
                width:.5rem;
                height:.5rem;
                border-radius:50%;
                background:var(--tt-accent);
                box-shadow:0 0 10px var(--tt-accent)
            }
            nav ul{
                display:flex;
                gap:8px;
                margin:0;
                padding:0;
                list-style:none
            }
            nav a{
                color:var(--tt-text);
                text-decoration:none;
                font-weight:600;
                padding:9px 12px;
                border-radius:10px;
                border:1px solid rgba(255,255,255,.06);
                background:rgba(255,255,255,.02);
                transition:background .15s ease,transform .15s ease,box-shadow .15s ease
            }
            nav a:hover{
                background:rgba(34,211,238,.10);
                transform:translateY(-1px)
            }
            nav a.active{
                background:rgba(34,211,238,.18);
                box-shadow:0 0 0 3px var(--tt-ring) inset
            }
            .page-wrap{
                max-width:1200px;
                margin:24px auto;
                padding:0 20px
            }
            .card{
                background:var(--tt-card);
                border:1px solid rgba(255,255,255,.06);
                border-radius:14px;
                box-shadow:0 10px 30px rgba(0,0,0,.25)
            }
            .toolbar{
                display:flex;
                flex-wrap:wrap;
                gap:10px;
                align-items:center;
                justify-content:space-between;
                padding:16px
            }
            .toolbar .title{
                font-weight:800;
                font-size:20px
            }
            .toolbar .filters{
                display:flex;
                gap:8px;
                flex-wrap:wrap
            }
            .toolbar input,.toolbar select{
                background:rgba(255,255,255,.03);
                color:var(--tt-text);
                border:1px solid rgba(255,255,255,.10);
                border-radius:10px;
                padding:8px 10px;
                outline:none;
                min-width:180px
            }
            .toolbar input:focus,.toolbar select:focus{
                box-shadow:0 0 0 3px var(--tt-ring);
                border-color:transparent
            }
            .table-wrap{
                overflow:auto;
                border-top:1px solid rgba(255,255,255,.06)
            }
            table{
                width:100%;
                border-collapse:separate;
                border-spacing:0;
                min-width:980px
            }
            thead th{
                position:sticky;
                top:0;
                z-index:1;
                background:rgba(17,24,39,.9);
                backdrop-filter:saturate(140%) blur(4px);
                text-align:left;
                font-weight:700;
                font-size:13px;
                letter-spacing:.3px;
                color:var(--tt-muted);
                padding:12px;
                border-bottom:1px solid rgba(255,255,255,.08)
            }
            tbody td{
                padding:14px 12px;
                border-bottom:1px solid rgba(255,255,255,.06);
                vertical-align:middle
            }
            tbody tr:hover{
                background:rgba(255,255,255,.02)
            }
            .prod{
                display:flex;
                align-items:center;
                gap:12px
            }
            .prod img{
                width:54px;
                height:54px;
                object-fit:cover;
                border-radius:10px;
                border:1px solid rgba(255,255,255,.06);
                background:#0b1220
            }
            .muted{
                color:var(--tt-muted);
                font-size:12px
            }
            .pill{
                display:inline-flex;
                align-items:center;
                gap:8px;
                padding:6px 10px;
                border-radius:999px;
                font-weight:700;
                font-size:12px;
                border:1px solid rgba(255,255,255,.08);
                background:rgba(255,255,255,.03)
            }
            .pill.pending{
                border-color:rgba(245,158,11,.35);
                background:rgba(245,158,11,.10)
            }
            .pill.completed,.pill.delivered{
                border-color:rgba(34,197,94,.35);
                background:rgba(34,197,94,.10)
            }
            .pill.cancelled,.pill.failed{
                border-color:rgba(239,68,68,.35);
                background:rgba(239,68,68,.10)
            }
            .price{
                font-weight:800
            }
            .tag{
                display:inline-block;
                padding:4px 8px;
                border-radius:999px;
                border:1px solid rgba(255,255,255,.1);
                font-size:11px
            }
            .tag+.tag{
                margin-left:6px
            }
            footer{
                background:rgba(15,23,42,.9);
                color:var(--tt-text);
                text-align:center;
                padding:1rem;
                margin-top:2rem
            }
        </style>
    </head>
    <body onload="loadPurchaseHistory()">
        <!-- Header -->
        <header class="tt-header" id="main-header">
            <div class="tt-wrap">
                <a href="index.html" class="tt-logo" aria-label="TechTopia Home">TechTopia</a>
                <nav aria-label="Primary">
                    <ul>
                        <li><a id="nav-home" href="index.html">Home</a></li>
                        <li><a id="nav-profile" href="my-account.html">My Profile</a></li>
                        <li><a id="nav-search" href="search.html">Search</a></li>
                        <li><a id="nav-cart" href="cart.html">My Cart</a></li>
                        <li><a id="nav-about" href="about.html">About Us</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="page-wrap">
            <div class="card">
                <div class="toolbar">
                    <div class="title">Purchased History</div>
                    <div class="filters">
                        <input id="q" type="search" placeholder="Search title, brand, model..." oninput="filterRows()">
                        <select id="brandFilter" onchange="filterRows()"><option value="">All Brands</option></select>
                        <select id="qualityFilter" onchange="filterRows()"><option value="">All Qualities</option></select>
                        <select id="statusFilter" onchange="filterRows()"><option value="">All Order Statuses</option></select>
                    </div>
                </div>

                <div class="table-wrap">
                    <table aria-label="Products table">
                        <thead>
                            <tr>
                                <th style="width:280px">Product</th>
                                <th>Brand / Model</th>
                                <th>Specs</th>
                                <th>Quality</th>
                                <th>Price</th>
                                <th>Qty</th>
                                <th>Order Status</th>
                                <th>Ordered On</th>
                                <th>Seller</th>
                            </tr>
                        </thead>
                        <tbody id="purchase-tbody"><!-- rows injected by JS --></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer><p>&copy; 2025 TechTopia. All rights reserved.</p></footer>

        <script src="assets/js/notification.js"></script>
        <script>
                    // Highlight active nav
                    (function () {
                        const file = (location.pathname.split('/').pop() || '').toLowerCase();
                        const map = {'index.html': 'nav-home', 'my-account.html': 'nav-profile', 'search.html': 'nav-search', 'cart.html': 'nav-cart', 'about.html': 'nav-about'};
                        const id = map[file];
                        if (id) {
                            document.getElementById(id)?.classList.add('active');
                        }
                    })();

                    // Helpers
                    const fmtMoney = (n) => {
                        const val = Number(n || 0);
                        return isFinite(val) ? val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : n;
                    };
                    const orderStatusClass = (s) => {
                        const k = String(s || '').toLowerCase();
                        if (k.includes('pending'))
                            return 'pending';
                        if (k.includes('complete') || k.includes('delivered'))
                            return 'delivered';
                        if (k.includes('cancel') || k.includes('fail'))
                            return 'cancelled';
                        return '';
                    };

                    // Normalize server payload: [{ id, product:{...}, qty, orderStatus:{value}, orders:{createdAt}, ...}]
                    function normalize(list) {
                        return (list || []).map(row => {
                            const p = row.product || {};
                            return {
                                id: p.id,
                                title: p.title,
                                model: p.model,
                                description: p.description,
                                price: p.price,
                                purchasedQty: row.qty ?? p.qty,
                                orderedAt: row?.orders?.createdAt || p.createdAt,
                                color: p.color,
                                storage: p.storage,
                                quality: p.quality,
                                productStatus: p.status, // not used for filtering, but shown subtly if needed
                                orderStatus: row.orderStatus, // <-- used for Status filter/pill
                                seller: p.user
                            };
                        });
                    }

                    // Row renderer (expects normalized object)
                    function renderRow(o) {
                        const brand = o?.model?.brand?.name || '-';
                        const model = o?.model?.name || '-';
                        const color = o?.color?.value || '-';
                        const storage = o?.storage?.value || '-';
                        const quality = o?.quality?.value || '-';
                        const oStatus = o?.orderStatus?.value || '-';
                        const pStatus = o?.productStatus?.value || '';
                        const img = `product-images/${o.id}/image1.png`;
                        const seller = ((o?.seller?.first_name || '') + ' ' + (o?.seller?.last_name || '')).trim();

                        const tr = document.createElement('tr');

                        // data attributes for filtering
                        tr.dataset.q = [
                            (o.title || ''), brand, model, color, storage, quality, oStatus, (o.description || '')
                        ].join(' ').toLowerCase();

                        tr.dataset.brand = (brand || '').toLowerCase();
                        tr.dataset.quality = (quality || '').toLowerCase();
                        tr.dataset.status = (oStatus || '').toLowerCase();

                        tr.innerHTML = `
              <td>
                <div class="prod">
                  <img src="${img}" alt="${o.title || 'Product'}" onerror="this.src='assets/img/placeholder.png'">
                  <div>
                    <div style="font-weight:700">${o.title || '-'}</div>
                    <div class="muted">${(o.description || '').slice(0, 80)}${(o.description || '').length > 80 ? '…' : ''}</div>
                    ${pStatus ? `<div class="muted">Product status: ${pStatus}</div>` : ''}
                  </div>
                </div>
              </td>
              <td>
                <div style="font-weight:600">${brand}</div>
                <div class="muted">${model}</div>
              </td>
              <td>
                <span class="tag">${storage}</span>
                <span class="tag">${color}</span>
              </td>
              <td>${quality}</td>
              <td class="price">$ ${fmtMoney(o.price)}</td>
              <td>${o.purchasedQty ?? '-'}</td>
              <td><span class="pill ${orderStatusClass(oStatus)}">${oStatus}</span></td>
              <td>${o.orderedAt || '-'}</td>
              <td>${seller || '-'}</td>
            `;
                        return tr;
                    }

                    // Build filter options
                    function hydrateFilters(list) {
                        const uniq = (arr) => Array.from(new Set(arr.filter(Boolean))).sort((a, b) => a.localeCompare(b));
                        const brands = uniq(list.map(o => o?.model?.brand?.name).map(x => String(x || '').trim()));
                        const qualities = uniq(list.map(o => o?.quality?.value).map(x => String(x || '').trim()));
                        const statuses = uniq(list.map(o => o?.orderStatus?.value).map(x => String(x || '').trim()));

                        const brandSel = document.getElementById('brandFilter');
                        const qualitySel = document.getElementById('qualityFilter');
                        const statusSel = document.getElementById('statusFilter');

                        [brandSel, qualitySel, statusSel].forEach(sel => {
                            while (sel.options.length > 1)
                                sel.remove(1);
                        });

                        brands.forEach(b => brandSel.add(new Option(b, b)));
                        qualities.forEach(q => qualitySel.add(new Option(q, q)));
                        statuses.forEach(s => statusSel.add(new Option(s, s)));
                    }

                    // === MAIN LOAD (keeps same name) ===
                    async function loadPurchaseHistory() {
                        const popup = new Notification();
                        try {
                            const res = await fetch('PurchaseHistory'); // your servlet
                            if (!res.ok)
                                throw new Error('Network error');
                            const json = await res.json();

                            // Server returns: { status: true, productList: [...] }
                            const raw = Array.isArray(json) ? json
                                    : (json?.productList || json?.items || []);
                            const list = normalize(raw);

                            const tbody = document.getElementById('purchase-tbody');
                            tbody.innerHTML = '';
                            list.forEach(o => tbody.appendChild(renderRow(o)));

                            hydrateFilters(list);
                        } catch (err) {
                            console.error(err);
                            popup.error({message: 'Something went wrong loading products.'});
                        }
                    }

                    // Filtering (unchanged signature)
                    function filterRows() {
                        const q = (document.getElementById('q').value || '').toLowerCase();
                        const b = (document.getElementById('brandFilter').value || '').toLowerCase();
                        const ql = (document.getElementById('qualityFilter').value || '').toLowerCase();
                        const s = (document.getElementById('statusFilter').value || '').toLowerCase();

                        const rows = document.querySelectorAll('#purchase-tbody tr');
                        rows.forEach(r => {
                            const matchQ = !q || r.dataset.q.includes(q);
                            const matchB = !b || r.dataset.brand === b;
                            const matchQl = !ql || r.dataset.quality === ql;
                            const matchS = !s || r.dataset.status === s;
                            r.style.display = (matchQ && matchB && matchQl && matchS) ? '' : 'none';
                        });
                    }
        </script>
    </body>
</html>
